<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>Ders ‚Äî HocAIm</title>

  <!-- Ana stiller -->
  <style>
    :root{
      --bg:#fffdf7; --panel:#ffffff; --text:#0b1220; --muted:#566074;
      --border:#e7e9ee; --blue:#3b82f6; --blue-700:#2563eb; --green:#16a34a;
      --shadow:0 12px 28px rgba(15,23,42,.08);
      --radius:18px;
    }
    *{ box-sizing:border-box }
    html,body{height:100%}
    body{ margin:0; background:var(--bg); color:var(--text); -webkit-font-smoothing:antialiased }
    .page{ max-width:1280px; margin:auto; padding:18px 20px 28px }

    /* Topbar */
    .topbar{ display:flex; align-items:center; gap:12px; margin:6px 0 14px }
    .btn{ display:inline-flex; align-items:center; gap:8px; padding:10px 14px;
          border:1.5px solid var(--text); border-radius:12px; font-weight:800; cursor:pointer; text-decoration:none; }
    .btn.blue{ background:var(--blue); color:#fff; border-color:var(--blue); box-shadow:0 8px 18px rgba(59,130,246,.18) }
    .btn.ghost{ border-color:var(--border); color:var(--text); background:#fff }
    .btn:focus-visible{ outline:3px solid rgba(59,130,246,.35) }
    .topbar h1{ margin:0; font-weight:900; letter-spacing:.2px }

    /* Layout */
    .layout{ display:grid; grid-template-columns:2.1fr .9fr; gap:16px; min-height:calc(100vh - 140px) }
    @media (max-width:1080px){ .layout{ grid-template-columns:1fr; min-height:auto } }

    /* Cards */
    .card{ background:var(--panel); border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow); padding:16px }
    .chat{ display:flex; flex-direction:column; min-height:560px }
    .chat-head{ display:flex; align-items:center; justify-content:space-between; padding-bottom:12px; border-bottom:1px solid var(--border) }
    .title{ font-weight:900; font-size:18px }
    .sub{ color:var(--muted); font-size:12px }

    /* Thread */
    .thread{ flex:1; overflow:auto; padding:10px 0; scroll-behavior:smooth }
    .msg{ display:flex; gap:10px; margin:12px 0; align-items:flex-start }
    .ava{ width:40px; height:40px; border-radius:999px; display:grid; place-items:center; background:var(--blue-700); color:#fff; font-weight:900; flex:0 0 40px }
    .me .ava{ background:#0b1220 }
    .bubble{ border:1px solid var(--border); border-radius:14px; padding:12px 14px; background:#fff; white-space:pre-wrap; word-break:break-word; max-width:100%; line-height:1.6 }
    .me .bubble{ background:#0b1220; color:#fff; border-color:#0b1220 }
    .msg .meta{ display:flex; gap:6px; align-items:center; margin-top:6px }
    .meta .chip-mini{ border:1px solid var(--border); border-radius:999px; padding:4px 8px; font-size:12px; color:var(--muted); background:#fff }

    /* Typing */
    .typing{ display:inline-flex; gap:6px; align-items:center }
    .dot{ width:6px; height:6px; border-radius:999px; background:#9aa3b2; opacity:.6; animation:b 1.2s infinite }
    .dot:nth-child(2){ animation-delay:.2s } .dot:nth-child(3){ animation-delay:.4s }
    @keyframes b{ 0%,80%,100%{ transform:translateY(0) } 40%{ transform:translateY(-3px) } }

    /* Foot */
    .foot{ display:flex; gap:10px; padding-top:12px; border-top:1px solid var(--border); background:#fff; position:sticky; bottom:0; z-index:3 }
    .in{ flex:1; padding:12px 14px; border:1px solid var(--border); border-radius:12px; font:inherit; background:#fff }
    .quick{ display:flex; gap:6px; flex-wrap:wrap; margin:8px 0 2px }
    .qchip{ border:1px dashed var(--border); color:var(--muted); background:#fff; padding:6px 10px; border-radius:999px; cursor:pointer; font-weight:600 }
    .qchip:hover{ border-style:solid }

    /* Side */
    .muted{ color:var(--muted) }
    .grid{ display:grid; grid-template-columns:1fr auto; gap:8px 12px }
    .progress{ height:10px; background:#f1f5f9; border-radius:999px; overflow:hidden; margin:12px 0 6px }
    .bar{ display:block; height:100%; width:0; background:linear-gradient(90deg,#22c55e,#16a34a) }
    .actions{ display:flex; gap:8px; flex-wrap:wrap }
    .actions .btn{ padding:8px 12px; border-radius:999px }
    .side .small{ font-size:12px; color:var(--muted) }

    /* Message actions */
    .mbtns{ display:flex; gap:6px; }
    .iconbtn{ border:1px solid var(--border); background:#fff; border-radius:10px; padding:6px 8px; cursor:pointer; color:var(--muted) }
    .iconbtn:hover{ color:var(--text) }

    @media (max-width:480px){
      .page{ padding:14px 12px 20px }
      .btn{ min-height:44px }
      .in{ min-height:44px; font-size:15px }
      .qchip{ font-size:13px; padding:6px 9px }
      .card{ border-radius:16px }
    }
  </style>
</head>
<body>
  <div class="page">
    <header class="topbar">
      <a href="dashboard.html" class="btn ghost">‚üµ Panel</a>
      <h1 class="lesson-title">Ders</h1>
    </header>

    <div class="layout">
      <!-- SOL: Sohbet -->
      <section class="card chat" aria-live="polite">
        <div class="chat-head">
          <div>
            <div id="title" class="title">Ders</div>
            <div class="sub">‚ÄúYapay zek√¢ anlatƒ±r, senin beynine g√∂re anlatƒ±r.‚Äù</div>
          </div>
          <div style="display:flex; gap:8px; align-items:center;">
            <span id="modeChip" class="btn ghost" style="border-radius:999px; font-weight:800;">Otomatik</span>
            <button id="btnQuiz" class="btn">üß† Peki≈ütir (Mini Quiz)</button>
          </div>
        </div>

        <div id="thread" class="thread"></div>

        <div class="quick" id="suggests"></div>

        <div class="foot">
          <input id="ask" class="in" placeholder='√ñrn: "Trigonometri" yaz ve ba≈üla; sonra sor: "sin-cos ili≈ükisi?"'/>
          <div style="display:flex; gap:8px;">
            <button id="stop" class="btn ghost" title="ƒ∞≈ülemi iptal et">Stop</button>
            <button id="send" class="btn blue">G√∂nder</button>
          </div>
        </div>
      </section>

      <!-- SAƒû: √ñzet & Hƒ±zlƒ± Aksiyon -->
      <aside class="card side">
        <h3>√ñzet</h3>
        <div class="grid">
          <span class="muted">Konu</span> <strong id="kvTopic">‚Äî</strong>
          <span class="muted">Stil</span> <strong id="kvStyle">Otomatik</strong>
          <span class="muted">S√ºre</span> <strong id="kvTime">10 dk</strong>
        </div>

        <div class="progress"><span id="bar" class="bar"></span></div>
        <small class="muted">ƒ∞lerleme: <span id="pp">0</span>%</small>

        <h3 style="margin-top:14px;">Hƒ±zlƒ± Aksiyon</h3>
        <div class="actions">
          <button id="actSimple"  class="btn ghost">Basitle≈ütir</button>
          <button id="actExample" class="btn ghost">Daha √ßok √∂rnek</button>
          <button id="actWhy"     class="btn ghost">‚ÄúNeden?‚Äù de</button>
          <button id="actRedo"    class="btn ghost" title="Aynƒ± konuyu farklƒ± yoldan anlat">Yeniden Anlat</button>
        </div>

        <div style="margin-top:16px">
          <div class="small">Not: Butonlar, **son AI cevabƒ±nƒ± ve konuyu** baƒülam olarak kullanƒ±r.</div>
        </div>
      </aside>
    </div>
  </div>

  <!-- ====== APP SCRIPT ====== -->
  <script>
    const $ = s => document.querySelector(s);

    // Profilden ba≈ülangƒ±√ß stili
    let profile = null; try{ profile = JSON.parse(localStorage.getItem('ch.profile')||'null'); }catch{}
    const initialStyle = profile?.primary?.code || 'auto';
    const styleLabel = c => ({V:'G√∂rsel',A:'ƒ∞≈üitsel',R:'Okuma-Yazma',K:'Kinestetik',auto:'Otomatik'})[c] || 'Otomatik';
    $('#kvStyle').textContent = styleLabel(initialStyle);
    $('#modeChip').textContent = styleLabel(initialStyle);

    const state = {
      topic: null,
      domain: 'general',
      style: initialStyle,
      level: profile?.level || 'lise',
      busy: false
    };

    /* ---------------- UI helpers ---------------- */
    const thread = $('#thread');

    function messageActions(text){
      const cont = document.createElement('div');
      cont.className = 'mbtns';
      const copy = document.createElement('button');
      copy.className='iconbtn'; copy.innerText='Kopyala';
      copy.onclick = ()=> navigator.clipboard.writeText(text||'');
      cont.appendChild(copy);
      return cont;
    }

    function addBot(html, metaText=''){
      const d=document.createElement('div'); d.className='msg';
      d.innerHTML = `
        <div class="ava">H</div>
        <div>
          <div class="bubble">${html}</div>
          <div class="meta">${metaText?`<span class="chip-mini">${metaText}</span>`:''}</div>
        </div>`;
      thread.appendChild(d); thread.scrollTop=thread.scrollHeight;
      turns.push({ role:'assistant', content:String(html).replace(/\s+/g,' ').slice(0,700) });
      maybeInferStyle();
      lastBotHTML = html;
    }

    function addTyping(){
      const d=document.createElement('div'); d.className='msg'; d.id='__typing';
      d.innerHTML = `<div class="ava">H</div><div class="bubble"><span class="typing"><span class="dot"></span><span class="dot"></span><span class="dot"></span></span></div>`;
      thread.appendChild(d); thread.scrollTop=thread.scrollHeight;
    }
    function removeTyping(){ const t=$('#__typing'); if(t) t.remove(); }

    function addMe(text){
      const d=document.createElement('div'); d.className='msg me';
      d.innerHTML = `<div class="bubble">${text}</div><div class="ava">üë§</div>`;
      thread.appendChild(d); thread.scrollTop=thread.scrollHeight;
      turns.push({ role:'user', content:text.slice(0,500) });
    }

    function setTitleTopic(){
      $('#title').textContent = state.topic ? `‚Äú${state.topic}‚Äù konusunu birlikte √∂ƒürenelim` : 'Ders';
      $('#kvTopic').textContent = state.topic || '‚Äî';
    }

    let pct=0; function tick(){ pct=Math.min(100,pct+8); $('#bar').style.width=pct+'%'; $('#pp').textContent=pct; }

    // Son bot cevabƒ±nƒ±n d√ºz metni
    function getLastBotText(){
      const nodes = Array.from(document.querySelectorAll('#thread .msg'));
      for (let i = nodes.length - 1; i >= 0; i--){
        if (!nodes[i].classList.contains('me')){
          const b = nodes[i].querySelector('.bubble');
          if (b) return b.innerText || b.textContent || '';
        }
      }
      return '';
    }

    /* ---------------- Konu √ßƒ±karƒ±m kurallarƒ± ---------------- */
    const TOPIC_RULES = [
      { re:/baƒüla√ß\w*/i,         canon:'Baƒüla√ßlar',         domain:'lang' },
      { re:/zamir\w*/i,          canon:'Zamirler',          domain:'lang' },
      { re:/sƒ±fat\w*/i,          canon:'Sƒ±fatlar',          domain:'lang' },
      { re:/fiil\w*/i,           canon:'Fiiller',           domain:'lang' },
      { re:/c√ºmle (√∂ƒüeleri|t√ºrleri|bilgisi)/i, canon:'C√ºmle Bilgisi', domain:'lang' },

      { re:/trigonometri/i,      canon:'Trigonometri',      domain:'math' },
      { re:/limit/i,             canon:'Limit',             domain:'math' },
      { re:/integral/i,          canon:'ƒ∞ntegral',          domain:'math' },
      { re:/t√ºrev/i,             canon:'T√ºrev',             domain:'math' },
    ];
    const STOP = new Set(['selam','merhaba','hocam','hoca','acaba','bana','yardƒ±m','eder','misin','nedir','nelerdir','nasƒ±l','konusunu','konusunda','hakkƒ±nda','ile','ilgili','anlamƒ±yorum','zorlanƒ±yorum','sƒ±kƒ±ntƒ±','ya≈üƒ±yorum','var','mƒ±','mi']);

    function extractTopic(raw){
      const lower = raw.toLowerCase().replace(/[^\p{L}\p{N}\s]/gu,' ').replace(/\s+/g,' ').trim();
      for (const r of TOPIC_RULES){ if (r.re.test(lower)) return { topic:r.canon, domain:r.domain }; }
      const words = lower.split(' ').filter(w=>!STOP.has(w)).slice(0,2);
      const t = words.map(w=>w.replace(/\b\p{L}/u,m=>m.toUpperCase())).join(' ');
      return { topic: t || 'Genel', domain:'general' };
    }

    /* ---------------- Sunucu k√∂pr√ºs√º ---------------- */
    let aborter = null;
    async function explain({ prompt, topic, extra }){
      // √ñƒüretmen ki≈üiliƒüi + m√ºfredat + stil/level sinyali + kƒ±sa baƒülam
      const persona = `Rol: Canƒ±m HocAIm ‚Äî empatik, motive edici T√ºrk√ße bir √∂ƒüretmen.
√ñƒürencinin seviyesine (${state.level}) ve stiline (${styleLabel(state.style)}) g√∂re anlat.
Teknik terimlerde kƒ±sa tanƒ±m ver, √∂rnekle. √ñƒürenci 100 kere sorsa 100 kere farklƒ± yoldan, sabƒ±rla anlat (kƒ±sa adƒ±mlar).
M√ºfredat: TR orta√∂ƒüretim ve lise seviyeleri √∂ncelikli.`;
      const history = JSON.stringify(turns.slice(-8)); // son 8 konu≈üma
      const body = { prompt, topic, style: state.style, level: state.level, context: persona + "\nContextTurns:" + history + (extra?("\nExtra:"+extra):"") };

      aborter = new AbortController();
      const r = await fetch('/api/explain',{
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify(body), signal: aborter.signal
      });
      return r.json();
    }

    /* ---------------- Stil √ßƒ±karƒ±mƒ± ---------------- */
    let turns=[]; let inferCounter=0;
    async function maybeInferStyle(){
      inferCounter++; if (inferCounter % 3 !== 0) return;
      try{
        const r = await fetch('/api/style-infer',{
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ turns: turns.slice(-8) })
        });
        const data = await r.json();
        if (data?.ok && data.style && data.confidence >= 60){
          state.style = data.style;
          const label = styleLabel(data.style);
          $('#kvStyle').textContent = label;
          $('#modeChip').textContent = label;
        }
      }catch(e){ /* sessiz */ }
    }

    /* ---------------- Kar≈üƒ±lama + √∂neriler ---------------- */
    function setSuggests(){
      const s = $('#suggests');
      const arr = state.topic ? [
        'Basit bir √∂rnek g√∂ster', 'Adƒ±m adƒ±m anlat', 'Beni test et', 'Farklƒ± y√∂ntemle a√ßƒ±kla'
      ] : [
        'Trigonometri', 'Limit', 'Baƒüla√ßlar', 'Zamirler'
      ];
      s.innerHTML = arr.map(x=>`<button class="qchip" data-q="${x}">${x}</button>`).join('');
      s.querySelectorAll('.qchip').forEach(el=>{
        el.onclick = ()=>{ $('#ask').value = state.topic ? xWithTopic(el.dataset.q) : el.dataset.q; $('#send').click(); };
      });
    }
    function xWithTopic(q){ return `${state.topic}: ${q}` }

    addBot('Hangi konuda yardƒ±mcƒ± olmamƒ± istersin? √ñrn: <em>limit, integral, trigonometri, baƒüla√ßlar, zamirler‚Ä¶</em>', 'Hazƒ±rƒ±m');
    setTitleTopic(); setSuggests();

    /* ---------------- G√∂nderme akƒ±≈üƒ± ---------------- */
    const $ask = $('#ask'); const $send = $('#send'); const $stop = $('#stop');
    let lastBotHTML = '';

    function guardBusy(){ if(state.busy){ addBot('Bir √∂nceki isteƒüi bitireyim, sonra devam edelim üôÇ'); return true } return false; }

    $send.addEventListener('click', async ()=>{
      const text = ($ask.value||'').trim(); if (!text) return;
      if (guardBusy()) return;
      addMe(text); $ask.value='';

      // Konu belirli deƒüilse, √ßƒ±kar ve giri≈ü √ºret
      if (!state.topic){
        const res = extractTopic(text);
        state.topic  = res.topic; state.domain = res.domain;
        setTitleTopic(); setSuggests();
        addTyping(); state.busy=true;
        try{
          const data = await explain({ topic: state.topic, prompt: `Kƒ±sa giri≈ü anlat: ${state.topic}` });
          removeTyping();
          addBot(data?.ok ? data.html : 'AI yanƒ±tƒ± alƒ±namadƒ±, tekrar dener misin?', 'Giri≈ü');
          if (data?.ok) tick();
        }catch(e){ removeTyping(); addBot('Bir hata olu≈ütu.'); }
        finally{ state.busy=false; }
        return;
      }

      // Konu belirlendiyse normal soru
      addTyping(); state.busy=true;
      try{
        const data = await explain({ prompt: text, topic: state.topic });
        removeTyping();
        addBot(data?.ok ? data.html : 'AI yanƒ±tƒ± alƒ±namadƒ±.', 'Cevap');
        if (data?.ok) tick();
      }catch(e){ removeTyping(); addBot('Bir hata olu≈ütu.'); }
      finally{ state.busy=false; }
    });

    $ask.addEventListener('keydown', e=>{
      if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); $send.click(); }
    });

    $stop.onclick = ()=>{ try{ aborter?.abort(); }catch{} removeTyping(); state.busy=false; };

    /* ---------------- Hƒ±zlƒ± aksiyonlar ---------------- */
    function topicGuard(){ if (!state.topic){ addBot('√ñnce bir konu yaz üôÇ'); return false; } return true; }

    $('#actSimple').addEventListener('click', async ()=>{
      if (!topicGuard() || guardBusy()) return;
      const base = getLastBotText() || `Konu: ${state.topic}`;
      const prompt = `KONU: ${state.topic}
STƒ∞L: ${styleLabel(state.style)}
A≈üaƒüƒ±daki a√ßƒ±klamayƒ± bu konu i√ßin daha basit, kƒ±sa ve 3 madde halinde √∂zetle. Gerekirse minik bir ipucu/benzetme ekle.
--- METƒ∞N ---
${base}
--- SON ---`;
      addTyping(); state.busy=true;
      const data = await explain({ prompt, topic: state.topic });
      removeTyping(); state.busy=false;
      addBot(data?.ok ? data.html : '‚Äî', 'Basitle≈ütir');
      if (data?.ok) tick();
    });

    $('#actExample').addEventListener('click', async ()=>{
      if (!topicGuard() || guardBusy()) return;
      const base = getLastBotText() || `Konu: ${state.topic}`;
      const isLang = state.domain === 'lang';
      const isMath = state.domain === 'math';
      const task = isLang
        ? `Bu konu T√úRK√áE Dƒ∞LBƒ∞LGƒ∞Sƒ∞ kapsamƒ±ndadƒ±r. 3 √∂rnek c√ºmle yaz:
- her c√ºmlenin yanƒ±na kƒ±sa a√ßƒ±klama koy
- yanlƒ±≈ü √∂rnek + d√ºzeltmesini de ekle (en az 1 adet)`
        : isMath
        ? `Bu konu MATEMATƒ∞K kapsamƒ±ndadƒ±r. 2 kolay + 1 orta seviye √á√ñZ√úML√ú soru √ºret:
- her soruyu adƒ±m adƒ±m √ß√∂z
- yaygƒ±n yapƒ±lan bir hatayƒ± g√∂ster ve d√ºzelt`
        : `Bu konu i√ßin 3 somut ve g√ºnl√ºk hayattan √∂rnek √ºret; her √∂rneƒüi kƒ±sa a√ßƒ±klamayla a√ßƒ±kla.`;
      const prompt = `KONU: ${state.topic}
STƒ∞L: ${styleLabel(state.style)}
${task}
--- ELƒ∞MDEKƒ∞ A√áIKLAMA ---
${base}
--- SON ---`;
      addTyping(); state.busy=true;
      const data = await explain({ prompt, topic: state.topic });
      removeTyping(); state.busy=false;
      addBot(data?.ok ? data.html : '‚Äî', '√ñrnekler');
      if (data?.ok) tick();
    });

    $('#actWhy').addEventListener('click', async ()=>{
      if (!topicGuard() || guardBusy()) return;
      const base = getLastBotText() || `Konu: ${state.topic}`;
      const prompt = `KONU: ${state.topic}
Bu kavram neden √∂nemlidir, nerelerde i≈üime yarar? 4-6 c√ºmlede a√ßƒ±kla.
1 ger√ßek hayat kullanƒ±m senaryosu ver. Dili ${styleLabel(state.style)} stile uygun, anla≈üƒ±lƒ±r olsun.
--- METƒ∞N ---
${base}
--- SON ---`;
      addTyping(); state.busy=true;
      const data = await explain({ prompt, topic: state.topic });
      removeTyping(); state.busy=false;
      addBot(data?.ok ? data.html : '‚Äî', 'Neden?');
      if (data?.ok) tick();
    });

    $('#actRedo').addEventListener('click', async ()=>{
      if (!topicGuard() || guardBusy()) return;
      const base = getLastBotText() || `Konu: ${state.topic}`;
      const prompt = `KONU: ${state.topic}
Aynƒ± konuyu FARKLI Bƒ∞R YOLDAN anlat. ƒ∞kinci bir yakla≈üƒ±m ver:
- √∂nce 3 maddelik kƒ±sa plan
- sonra 6-10 c√ºmle a√ßƒ±klama
- 1 benzetme + 1 mini ipucu
${styleLabel(state.style)} stiline uygun konu≈ü. 
--- METƒ∞N ---
${base}
--- SON ---`;
      addTyping(); state.busy=true;
      const data = await explain({ prompt, topic: state.topic });
      removeTyping(); state.busy=false;
      addBot(data?.ok ? data.html : '‚Äî', 'Yeniden Anlat');
      if (data?.ok) tick();
    });

    // Quiz
    $('#btnQuiz').addEventListener('click', ()=>{
      const t = state.topic || 'Genel';
      location.href = `quiz.html?topic=${encodeURIComponent(t)}`;
    });

    // √ñneri √ßipleri tƒ±klama
    $('#suggests').addEventListener('click', (e)=>{
      const el = e.target.closest('[data-q]'); if(!el) return;
      const q = el.getAttribute('data-q');
      $('#ask').value = state.topic ? xWithTopic(q) : q; $('#send').click();
    });
  </script>
</body>
</html>
