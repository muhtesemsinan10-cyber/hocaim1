<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>Ders ‚Äî HocAIm</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800&display=swap" rel="stylesheet"/>

  <style>
    :root{
      --bg:#fffdf7; --text:#0b1220; --muted:#475569; --border:#e5e7eb;
      --blue:#3b82f6; --card:#ffffff;
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0; background:var(--bg); color:var(--text);
      font-family:'Montserrat',system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',sans-serif;
    }

    /* Sol panel + saƒü chat */
    .page{ max-width:1200px; margin:auto; padding:16px;
      display:grid; grid-template-columns:300px 1fr; gap:16px; }
    @media(max-width:880px){ .page{ grid-template-columns:1fr; } }

    .card{ background:var(--card); border:1px solid var(--border);
      border-radius:16px; box-shadow:0 6px 18px rgba(0,0,0,.05); }

    /* SOL PANEL */
    .side{ padding:16px; }
    .back{ text-decoration:none; border:1px solid var(--border);
      border-radius:10px; padding:6px 10px; display:inline-flex;
      align-items:center; gap:6px; background:#fff; font-weight:600; margin-bottom:10px; }
    .brand{ font-weight:800; font-size:20px; margin-bottom:10px; display:flex; align-items:center; gap:6px; }
    .kv{ border-top:1px solid var(--border); padding-top:8px; margin-top:8px; font-size:14px; }
    .kv .row{ display:flex; justify-content:space-between; margin:4px 0; }
    .progress{ height:8px; background:#f1f5f9; border-radius:999px; overflow:hidden; margin:10px 0; }
    .bar{ width:0; height:100%; background:linear-gradient(90deg,#22c55e,#16a34a); transition:.3s; }
    .tiny{ font-size:12px; color:var(--muted); }

    .actions{ display:flex; flex-wrap:wrap; gap:6px; margin-top:8px; }
    .chipbtn{ border:1px solid var(--border); border-radius:999px;
      padding:8px 12px; background:#fff; font-weight:700; cursor:pointer; }
    .chipbtn:active{ transform:translateY(1px); }

    .quiz{ display:flex; align-items:center; gap:8px; border:1px dashed var(--border);
      padding:10px; border-radius:12px; margin-top:12px; }
    .convos{ margin-top:14px; }
    .conv-list{ display:flex; flex-direction:column; gap:6px; }
    .conv{ border:1px solid var(--border); border-radius:10px; background:#fff;
      padding:8px 10px; font-weight:600; display:flex; justify-content:space-between; cursor:pointer; }
    .conv small{ color:var(--muted); }

    /* SAƒû CHAT */
    .chat{ padding:14px; display:flex; flex-direction:column; height:100dvh; }
    .title{ font-size:22px; font-weight:800; margin:0 0 2px; }
    .subtitle{ margin:0 0 10px; color:var(--muted); font-size:13px; }

    .messages{
      flex:1; overflow:auto; background:#fff; border:1px solid var(--border);
      border-radius:14px; padding:12px; scroll-behavior:smooth;
    }
    .msg{ display:flex; gap:10px; margin:8px 0; max-width:860px; }
    .bubble{ border:1px solid var(--border); padding:12px 14px; border-radius:14px;
      line-height:1.5; white-space:pre-wrap; word-break:break-word; }
    .msg.user{ justify-content:flex-end; }
    .msg.user .bubble{ background:#0b1220; color:#fff; border-color:#0b1220; }
    .msg.ai .bubble{ background:#fff; }

    .composer{ position:sticky; bottom:0; background:var(--bg);
      border-top:1px solid var(--border); padding-top:10px; margin-top:10px; }
    .composer-inner{ display:flex; gap:8px; align-items:center;
      background:#fff; border:1px solid var(--border);
      border-radius:12px; padding:8px 10px; }
    .composer textarea{
      flex:1; resize:none; border:0; outline:0; background:transparent;
      max-height:160px; font:inherit;
    }
    .btn{ border:none; background:var(--blue); color:#fff;
      font-weight:800; padding:10px 16px; border-radius:12px; cursor:pointer;
      box-shadow:0 4px 12px rgba(59,130,246,.25); }
    .btn.secondary{ background:#f1f5f9; color:#0b1220; border:1px solid var(--border); box-shadow:none; }
    .btn:disabled{ opacity:.6; cursor:not-allowed; }

    .bubble.typing::after{ content:" ‚ñå"; animation:blink 1s steps(1) infinite; }
    @keyframes blink{ 50%{opacity:0;} }
  </style>
</head>
<body>
  <div class="page">
    <!-- SOL PANEL -->
    <aside class="card side">
      <a href="index.html" class="back">‚üµ Anasayfa</a>
      <div class="brand"><span>ü§ñ</span> HocAIm</div>

      <div class="kv">
        <div class="row"><span>Konu</span><strong id="kvTopic">‚Äî</strong></div>
        <div class="row"><span>Stil</span><strong id="kvStyle">Otomatik</strong></div>
        <div class="row"><span>S√ºre</span><strong>10 dk</strong></div>
      </div>

      <div class="progress"><div class="bar" id="bar"></div></div>
      <div class="tiny">ƒ∞lerleme: <span id="pp">0</span>%</div>

      <div class="actions">
        <button class="chipbtn" id="actSimple">Basitle≈ütir</button>
        <button class="chipbtn" id="actExample">Daha √ßok √∂rnek</button>
        <button class="chipbtn" id="actWhy">‚ÄúNeden?‚Äù de</button>
        <button class="chipbtn" id="actReExplain">Yeniden Anlat</button>
      </div>

      <div class="quiz">
        <span>üß†</span>
        <div style="flex:1">
          <div style="font-weight:800">Peki≈ütir (Mini Quiz)</div>
          <div class="tiny">Se√ßili konuya g√∂re otomatik hazƒ±rlanƒ±r.</div>
        </div>
        <a id="btnQuiz" class="chipbtn" style="font-weight:800">Ba≈ülat</a>
      </div>

      <div class="convos">
        <h4>Sohbetler</h4>
        <div class="conv-list" id="convList"></div>
        <button id="btnNew" class="chipbtn" style="margin-top:8px">+ Yeni Sohbet</button>
      </div>
    </aside>

    <!-- SAƒû CHAT -->
    <section class="card chat">
      <h2 class="title" id="title">Ders</h2>
      <p class="subtitle">‚ÄúYapay zek√¢ anlatƒ±r, senin beynine g√∂re anlatƒ±r.‚Äù</p>

      <div class="messages" id="messages"></div>

      <div class="composer">
        <div class="composer-inner">
          <textarea id="composerInput" rows="1" placeholder='√ñrn: "Termodinamik" yaz, sonra "ƒ±sƒ± ve sƒ±caklƒ±k farkƒ±?"'></textarea>
          <button id="stopBtn" class="btn secondary">Durdur</button>
          <button id="sendBtn" class="btn">G√∂nder</button>
        </div>
      </div>
    </section>
  </div>

  <script>
    /* ====== Yardƒ±mcƒ±lar ====== */
    const $ = s => document.querySelector(s);
    const messages = $('#messages');
    const textarea = $('#composerInput');
    const sendBtn = $('#sendBtn');
    const stopBtn = $('#stopBtn');
    let controller = null, pct = 0;

    function appendMsg(role, html=''){
      const row = document.createElement('div');
      row.className = `msg ${role}`;
      const bubble = document.createElement('div');
      bubble.className = 'bubble';
      bubble.innerHTML = html;
      row.appendChild(bubble);
      messages.appendChild(row);
      messages.scrollTop = messages.scrollHeight;
      return bubble;
    }
    async function typeInto(el, chunk, speed=8){
      for(const ch of chunk){
        const safe = ch==='<'?'&lt;':ch==='>'?'&gt;':ch;
        el.innerHTML += safe;
        messages.scrollTop = messages.scrollHeight;
        if(speed) await new Promise(r=>setTimeout(r,speed));
      }
    }
    function setProgress(){
      document.getElementById('bar').style.width = pct + '%';
      document.getElementById('pp').textContent = pct;
    }

    /* ====== Konu durumu ====== */
    const state = { topic:null, style:'Otomatik' };
    document.getElementById('kvStyle').textContent = 'Otomatik';
    function setTopic(t){
      state.topic = t;
      document.getElementById('kvTopic').textContent = t || '‚Äî';
      document.getElementById('title').textContent = t ? `‚Äú${t}‚Äù konusunu √∂ƒürenelim` : 'Ders';
      // aktif sohbet ba≈ülƒ±ƒüƒ±nƒ± da g√ºncelle
      const c = getActive(); if (c){ c.title = t || 'Sohbet'; save(); renderConvos(); }
    }
    function inferTopic(text){
      text = (text||'').toLowerCase();
      const pairs = [
        [/frekans/,'Frekans'], [/limit/,'Limit'], [/integral/,'ƒ∞ntegral'],
        [/t√ºrev/,'T√ºrev'], [/term[o√∂]dinamik/,'Termodinamik']
      ];
      for(const [re,name] of pairs){ if(re.test(text)) return name; }
      return null;
    }

    /* ====== Streaming explain (JSON fallback‚Äôlƒ±) ====== */
    async function askExplain(message, topic){
      appendMsg('user', message);
      const aiBubble = appendMsg('ai','');
      aiBubble.classList.add('typing');
      controller = new AbortController();

      try{
        const res = await fetch('/api/explain', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ message, topic }),
          signal: controller.signal
        });
        if(!res.ok) throw new Error('fetch failed');
        const ct = (res.headers.get('content-type') || '').toLowerCase();

        // JSON d√∂nerse (bazƒ± guard/ilk cevaplar)
        if (ct.includes('application/json')) {
          const data = await res.json();
          const html = data.html || data.text || JSON.stringify(data);
          aiBubble.classList.remove('typing');
          aiBubble.innerHTML = html;
          pct = Math.min(100, pct+10); setProgress();
          if(!state.topic){ const m = inferTopic(html); if(m) setTopic(m); }
          return;
        }

        // text/plain stream
        if (!res.body || !ct.includes('text/plain')) {
          const txt = await res.text();
          aiBubble.classList.remove('typing');
          aiBubble.innerHTML = txt;
          if(!state.topic){ const m = inferTopic(txt); if(m) setTopic(m); }
          return;
        }

        const reader = res.body.getReader();
        const dec = new TextDecoder();
        let buf = '';
        while(true){
          const {value,done} = await reader.read();
          if(done) break;
          const chunk = dec.decode(value,{stream:true});
          buf += chunk;
          await typeInto(aiBubble, chunk, 8); // uzun cevaplarda 0 yap ‚Üí anƒ±nda
        }
        aiBubble.classList.remove('typing');
        pct = Math.min(100, pct+10); setProgress();
        if(!state.topic){ const m = inferTopic(buf); if(m) setTopic(m); }
      }catch(err){
        aiBubble.classList.remove('typing');
        aiBubble.textContent = 'Baƒülantƒ± kesildi.';
      }finally{
        controller = null;
      }
    }

    /* ====== Enter & G√∂nder & Durdur ====== */
    sendBtn.onclick = ()=>{
      const val = textarea.value.trim();
      if(!val) return;
      textarea.value = '';
      if(!state.topic){ const maybe = inferTopic(val); if(maybe) setTopic(maybe); }
      askExplain(val, state.topic);
      textarea.focus();
    };
    textarea.addEventListener('keydown',e=>{
      if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); sendBtn.click(); }
    });
    stopBtn.onclick = ()=>{ try{ controller?.abort(); }catch{} };

    /* ====== Aksiyon butonlarƒ± (son konu baƒülamlƒ±) ====== */
    function runAction(prompt){
      if(!state.topic){ appendMsg('ai','√ñnce bir konu yazmalƒ±sƒ±n üôÇ'); return; }
      const merged = `${prompt}\n\nKonu: ${state.topic}`;
      askExplain(merged, state.topic);
    }
    document.getElementById('actSimple').onclick   = ()=> runAction('Bu konuyu daha basit, 3 maddede √∂zetle. K√º√ß√ºk ipucu ekle.');
    document.getElementById('actExample').onclick  = ()=> runAction('Bu konu i√ßin 2 kolay + 1 orta seviye √ß√∂z√ºml√º soru √ºret.');
    document.getElementById('actWhy').onclick      = ()=> runAction('Bu kavram neden √∂nemli? 4-6 c√ºmlede a√ßƒ±kla, 1 ger√ßek hayat √∂rneƒüi ver.');
    document.getElementById('actReExplain').onclick= ()=> runAction('Aynƒ± konuyu farklƒ± bir √ºslupla yeniden a√ßƒ±kla.');

    /* ====== Quiz (g√ºncel topic) ====== */
    document.getElementById('btnQuiz').onclick = ()=>{
      const t = state.topic || 'Genel';
      location.href = `quiz.html?topic=${encodeURIComponent(t)}`;
    };

    /* ====== Sohbetler (localStorage) + yeni sohbette ho≈ü geldin ====== */
    const STORE="hocaim.convos";
    let convos = JSON.parse(localStorage.getItem(STORE) || "[]");
    let activeId = convos[0]?.id || null;

    function save(){ localStorage.setItem(STORE, JSON.stringify(convos)); }
    function renderConvos(){
      const list = document.getElementById('convList'); list.innerHTML='';
      convos.forEach(c=>{
        const div=document.createElement('div');
        div.className='conv';
        div.innerHTML=`<span>${c.title||'Sohbet'}</span><small>‚ûú</small>`;
        div.onclick=()=>{ activeId=c.id; loadChat(); };
        list.appendChild(div);
      });
    }
    function ensureActive(){
      if(!activeId){
        const id=Date.now().toString();
        convos.unshift({id,title:'Yeni sohbet',turns:[]});
        activeId=id; save();
      }
    }
    function loadChat(){
      const c = convos.find(x=>x.id===activeId);
      messages.innerHTML='';
      state.topic=null;
      if(!c) return;
      setTopic(c.title!=='Yeni sohbet'?c.title:null);
      for(const t of c.turns){ appendMsg(t.role, t.content); }
    }

    document.getElementById('btnNew').onclick=()=>{
      const id=Date.now().toString();
      convos.unshift({id,title:'Yeni sohbet',turns:[]});
      activeId=id; save(); renderConvos(); loadChat();
      // yeni sohbette hocaim ilk mesajƒ± atsƒ±n
      appendMsg('ai','Selam, ben <strong>HocAIm</strong>! Hangi konuda √ßalƒ±≈ümak istersin?');
    };

    // ƒ∞lk y√ºkleme
    ensureActive(); renderConvos(); loadChat();
    if((convos.find(x=>x.id===activeId)?.turns||[]).length===0){
      appendMsg('ai','Selam, ben <strong>HocAIm</strong>! Hangi konuda √ßalƒ±≈ümak istersin?');
    }
  </script>
</body>
</html>
