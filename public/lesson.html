<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>Ders ‚Äî HocAIm</title>

  <!-- Montserrat -->
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800&display=swap" rel="stylesheet"/>

  <style>
    :root{
      --bg:#fffdf7; --text:#0b1220; --muted:#475569; --border:#e5e7eb; --blue:#3b82f6;
      --card:#ffffff;
    }
    *{ box-sizing:border-box }
    html,body{ height:100% }
    body{ margin:0; background:var(--bg); color:var(--text); font-family:'Montserrat',system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',sans-serif }

    .page{ max-width:1200px; margin:0 auto; padding:16px; display:grid; grid-template-columns:300px 1fr; gap:16px; }
    @media (max-width: 880px){ .page{ grid-template-columns:1fr } }

    .card{ background:var(--card); border:1px solid var(--border); border-radius:16px; box-shadow:0 8px 20px rgba(0,0,0,.06) }

    /* LEFT */
    .side{ padding:14px }
    .brand{ display:flex; align-items:center; gap:8px; font-weight:800; font-size:18px; margin-bottom:10px }
    .back{ text-decoration:none; border:1px solid var(--border); border-radius:10px; padding:6px 10px; display:inline-flex; gap:8px; align-items:center; font-weight:600; margin-bottom:10px; background:#fff }
    .kv{ font-size:14px; border-top:1px solid var(--border); padding-top:10px; margin-top:8px }
    .kv .row{ display:flex; justify-content:space-between; gap:12px; padding:3px 0 }
    .progress{ height:10px; background:#f1f5f9; border-radius:999px; overflow:hidden; margin:10px 0 }
    .bar{ width:0; height:100%; background:linear-gradient(90deg,#22c55e,#16a34a) }

    .actions{ display:flex; flex-wrap:wrap; gap:8px; margin-top:8px }
    .chipbtn{ border:1px solid var(--border); border-radius:999px; padding:8px 12px; background:#fff; font-weight:700; cursor:pointer }
    .chipbtn:active{ transform:translateY(1px) }

    .quiz{ display:flex; align-items:center; gap:10px; border:1px dashed var(--border); padding:10px; border-radius:12px; margin-top:12px }

    .convos{ margin-top:10px }
    .convos h4{ margin:10px 0 8px 0 }
    .conv-list{ display:flex; flex-direction:column; gap:6px }
    .conv{ display:flex; justify-content:space-between; align-items:center; border:1px solid var(--border); border-radius:10px; background:#fff; padding:8px 10px; font-weight:600; cursor:pointer }
    .conv small{ font-weight:600; color:var(--muted) }

    /* CHAT */
    .chat{ padding:14px; display:flex; flex-direction:column; min-height:calc(100vh - 32px - 32px); }
    @media (max-width:880px){ .chat{ min-height:70vh } }

    .title{ font-size:22px; font-weight:800; margin:0 0 2px }
    .subtitle{ margin:0 0 12px; color:var(--muted); font-size:13px }

    .thread{ flex:1; overflow:auto; padding:8px; border:1px solid var(--border); border-radius:14px; background:#fff }
    .msg{ display:flex; gap:10px; margin:10px 0; max-width:860px }
    .msg .bubble{ border:1px solid var(--border); background:#fff; padding:12px 14px; border-radius:14px; line-height:1.5; white-space:pre-wrap; word-break:break-word }
    .msg.me{ margin-left:auto; justify-content:flex-end }
    .msg.me .bubble{ background:#0b1220; color:#fff; border-color:#0b1220 }

    .foot{ display:flex; gap:8px; margin-top:10px }
    .in{ flex:1; padding:12px; border:1px solid var(--border); border-radius:12px; font:inherit }
    .btn{ border:none; background:var(--blue); color:#fff; font-weight:800; padding:12px 16px; border-radius:12px; cursor:pointer; box-shadow:0 6px 16px rgba(59,130,246,.22) }
    .btn:disabled{ opacity:.6; cursor:not-allowed }
    .btn.secondary{ background:#f1f5f9; color:#0b1220; border:1px solid var(--border); box-shadow:none }

    .tiny{ font-size:12px; color:var(--muted) }
  </style>
</head>
<body>
  <div class="page">
    <!-- LEFT -->
    <aside class="card side">
      <a href="dashboard.html" class="back">‚üµ Panel</a>
      <div class="brand"><span class="logo">H</span> HocAIm</div>

      <div class="kv">
        <div class="row"><span>Konu</span><strong id="kvTopic">‚Äî</strong></div>
        <div class="row"><span>Stil</span><strong id="kvStyle">Otomatik</strong></div>
        <div class="row"><span>S√ºre</span><strong>10 dk</strong></div>
      </div>

      <div class="progress"><div class="bar" id="bar"></div></div>
      <div class="tiny">ƒ∞lerleme: <span id="pp">0</span>%</div>

      <div class="actions">
        <button class="chipbtn" id="actSimple">Basitle≈ütir</button>
        <button class="chipbtn" id="actExample">Daha √ßok √∂rnek</button>
        <button class="chipbtn" id="actWhy">‚ÄúNeden?‚Äù de</button>
        <button class="chipbtn" id="actReExplain">Yeniden Anlat</button>
      </div>

      <div class="quiz">
        <span>üß†</span>
        <div style="flex:1">
          <div style="font-weight:800">Peki≈ütir (Mini Quiz)</div>
          <div class="tiny">Se√ßili konuya g√∂re otomatik hazƒ±rlanƒ±r.</div>
        </div>
        <a id="btnQuiz" class="chipbtn" style="font-weight:800">Ba≈ülat</a>
      </div>

      <div class="convos">
        <h4>Sohbetler</h4>
        <div class="conv-list" id="convList">
          <!-- JS doldurur -->
        </div>
        <button id="btnNew" class="chipbtn" style="margin-top:8px">+ Yeni Sohbet</button>
      </div>
    </aside>

    <!-- CHAT -->
    <section class="card chat">
      <h2 class="title" id="title">Ders</h2>
      <p class="subtitle">‚ÄúYapay zek√¢ anlatƒ±r, senin beynine g√∂re anlatƒ±r.‚Äù</p>

      <div id="thread" class="thread"></div>

      <div class="foot">
        <input id="ask" class="in" placeholder='√ñrn: "Trigonometri" yaz ve ba≈üla; sonra sor: "sin-cos ili≈ükisi?"'/>
        <button id="btnStop" class="btn secondary">Stop</button>
        <button id="send" class="btn">G√∂nder</button>
      </div>
    </section>
  </div>

  <script>
    const $ = s => document.querySelector(s);

    // ---- Basit sohbet y√∂netimi (localStorage) ----
    const STORE_KEY = "hocaim.convos";
    let convos = JSON.parse(localStorage.getItem(STORE_KEY) || "[]");
    let activeId = convos[0]?.id || null;

    function saveConvos(){ localStorage.setItem(STORE_KEY, JSON.stringify(convos)); }
    function ensureActive(){ if(!activeId){ const id = Date.now().toString(); convos.unshift({id, title:"Yeni sohbet", turns:[]}); activeId=id; saveConvos(); } }
    function getActive(){ return convos.find(c=>c.id===activeId); }
    function pushTurn(role, content){ const c=getActive(); if(!c) return; c.turns.push({role, content}); saveConvos(); }
    function setTitle(t){ const c=getActive(); if(!c) return; c.title = t; saveConvos(); renderConvos(); }

    function renderConvos(){
      const list = $('#convList'); list.innerHTML='';
      convos.forEach(c=>{
        const div = document.createElement('div');
        div.className='conv';
        div.innerHTML = `<span>${c.title || 'Sohbet'}</span><small>‚ûú</small>`;
        div.onclick = ()=>{ activeId = c.id; saveConvos(); loadActive(); };
        list.appendChild(div);
      });
    }

    function loadActive(){
      const c = getActive(); if(!c){ ensureActive(); renderConvos(); return loadActive(); }
      thread.innerHTML=''; state.topic=null; pct=0; prog();
      c.turns.forEach(t=>{
        if(t.role==='assistant') addBot(t.content, false);
        else addMe(t.content, false);
      });
      if(c.title && c.title !== 'Yeni sohbet'){ updateTopic(c.title); }
    }

    $('#btnNew').onclick = ()=>{
      const id = Date.now().toString();
      convos.unshift({id, title:"Yeni sohbet", turns:[]});
      activeId = id; saveConvos(); renderConvos(); loadActive();
    };

    // ---- G√∂rsel / UI ----
    const thread = $('#thread');
    let pct=0; function prog(){ $('#bar').style.width=pct+'%'; $('#pp').textContent = pct; }
    function tick(){ pct=Math.min(100, pct+10); prog(); }

    function addBot(text, persist=true){
      const d=document.createElement('div'); d.className='msg';
      d.innerHTML=`<div class="bubble">${text}</div>`;
      thread.appendChild(d); thread.scrollTop=thread.scrollHeight;
      if(persist) pushTurn('assistant', text);
      lastBotTextCache = text;
    }
    function addMe(text, persist=true){
      const d=document.createElement('div'); d.className='msg me';
      d.innerHTML=`<div class="bubble">${text}</div>`;
      thread.appendChild(d); thread.scrollTop=thread.scrollHeight;
      if(persist) pushTurn('user', text);
    }

    let lastBotTextCache = '';
    function lastBotText(){ return lastBotTextCache || ''; }

    // ---- Durum ----
    let profile=null; try{ profile = JSON.parse(localStorage.getItem('ch.profile')||'null'); }catch{}
    const state = { topic:null, style: (profile?.primary?.code || 'Otomatik'), level: profile?.level || 'Lise' };
    $('#kvStyle').textContent = ({"V":"G√∂rsel","A":"ƒ∞≈üitsel","R":"Okuma-Yazma","K":"Kinestetik","Otomatik":"Otomatik"})[state.style] || 'Otomatik';

    function updateTopic(t){
      state.topic = t;
      $('#kvTopic').textContent = t || '‚Äî';
      $('#title').textContent = t ? `‚Äú${t}‚Äù konusunu birlikte √∂ƒürenelim` : 'Ders';
      setTitle(t || "Sohbet");
    }

    // konu √ßƒ±karƒ±mƒ± (√ßok basit)
    function inferTopicFrom(text){
      const m = (text||'').toLowerCase();
      const pairs = [
        [/trigonometri/,'Trigonometri'], [/limit/,'Limit'], [/integral/,'ƒ∞ntegral'], [/t√ºrev/,'T√ºrev'],
        [/term[o√∂]dinamik/,'Termodinamik'], [/baƒüla[√ßc]/,'Baƒüla√ßlar'], [/zamir/,'Zamirler'], [/sƒ±fat/,'Sƒ±fatlar']
      ];
      for(const [re,name] of pairs){ if(re.test(m)) return name; }
      const first = (m.replace(/[^a-zƒü√º≈ü√∂√ßƒ±0-9\s]/gi,'').trim().split(/\s+/)[0]||'').toLowerCase();
      if(first) return first[0].toUpperCase()+first.slice(1);
      return null;
    }

    // ---- ƒ∞lk mesaj (kar≈üƒ±lama) ----
    ensureActive(); renderConvos(); loadActive();
    if(getActive().turns.length===0){
      addBot('Selam, ben <strong>HocAIm</strong>! Yapay zek√¢ destekli bir hocayƒ±m. <em>Senin anladƒ±ƒüƒ±n ≈üekilde</em> yardƒ±mcƒ± olmak i√ßin buradayƒ±m. Hangi konuda yardƒ±m istersin?');
    }

    // ---- Streaming k√∂pr√ºs√º + fallback ----
    let controller=null;

    async function explainStream({prompt,topic}){
      controller = new AbortController();
      const res = await fetch('/api/explain', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ prompt, topic, style: state.style, level: state.level, stream: true }),
        signal: controller.signal
      });

      const ct = (res.headers.get('content-type') || '').toLowerCase();
      if (!res.body || ct.includes('application/json')) {
        const data = await res.json().catch(()=>null);
        const text = (data && (data.html || data.text)) ? (data.html || data.text) : JSON.stringify(data||{});
        return { mode: 'plain', text };
      }
      if (ct.includes('text/plain') || res.body) {
        return { mode: 'stream', reader: res.body.getReader() };
      }
      const text = await res.text();
      return { mode: 'plain', text };
    }

    function addStreamBot(){
      const d=document.createElement('div'); d.className='msg';
      const b=document.createElement('div'); b.className='bubble'; d.appendChild(b);
      let done=false; let acc='';
      return {
        mount(){ thread.appendChild(d); thread.scrollTop=thread.scrollHeight; },
        append(t){ acc+=t; b.textContent=acc; thread.scrollTop=thread.scrollHeight; },
        done(){ if(!done){ done=true; pushTurn('assistant', acc); lastBotTextCache=acc; tick(); } },
        fail(){ if(!done){ done=true; b.textContent=(acc||'Bir hata olu≈ütu.'); } }
      };
    }

    async function handleSend(){
      const text = ($('#ask').value||'').trim();
      if(!text) return;
      addMe(text); $('#ask').value=''; $('#send').disabled=true;

      if(!state.topic){ const t = inferTopicFrom(text); if(t) updateTopic(t); }

      const streamer = addStreamBot(); streamer.mount();
      try{
        const result = await explainStream({prompt:text, topic: state.topic});
        if(result.mode === 'stream'){
          const dec = new TextDecoder();
          while(true){
            const {value, done} = await result.reader.read();
            if(done) break;
            streamer.append(dec.decode(value, {stream:true}));
          }
          streamer.done();
        }else{
          streamer.append(result.text);
          streamer.done();
        }
      }catch(e){
        streamer.fail();
      }finally{
        controller=null; $('#send').disabled=false;
      }
    }

    $('#send').onclick = handleSend;
    $('#ask').addEventListener('keydown', e=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); handleSend(); }});
    $('#btnStop').onclick = ()=>{ try{ controller?.abort(); }catch{} };

    async function runAction(prompt){
      if(!state.topic){ addBot('√ñnce bir konu yaz üôÇ'); return; }
      const base = lastBotText() || `Konu: ${state.topic}`;
      const text = `${prompt}\n\n--- METƒ∞N ---\n${base}\n--- SON ---`;
      addMe(prompt);
      const streamer = addStreamBot(); streamer.mount();
      try{
        const result = await explainStream({prompt: text, topic: state.topic});
        if(result.mode === 'stream'){
          const dec=new TextDecoder();
          while(true){
            const {value,done}=await result.reader.read();
            if(done) break;
            streamer.append(dec.decode(value,{stream:true}));
          }
          streamer.done();
        }else{
          streamer.append(result.text);
          streamer.done();
        }
      }catch(e){ streamer.fail() }
    }

    $('#actSimple').onclick = ()=> runAction('A√ßƒ±klamayƒ± bu konu i√ßin daha basit, kƒ±sa ve 3 madde halinde √∂zetle. Minik bir ipucu/benzetme ekle.');
    $('#actExample').onclick= ()=> runAction('Bu konu i√ßin 2 kolay + 1 orta seviye √ß√∂z√ºml√º soru veya 3 somut √∂rnek √ºret.');
    $('#actWhy').onclick    = ()=> runAction('Bu kavram neden √∂nemlidir, nerelerde i≈üime yarar? 4-6 c√ºmlede a√ßƒ±kla ve 1 ger√ßek hayat senaryosu ver.');
    $('#actReExplain').onclick=()=> runAction('Aynƒ± konuyu farklƒ± bir yoldan tekrar a√ßƒ±kla, √∂ƒürencinin farklƒ± bir tarzda anlamasƒ±na yardƒ±m et.');

    // Quiz
    $('#btnQuiz').onclick = ()=>{
      const t = state.topic || 'Genel';
      location.href = `quiz.html?topic=${encodeURIComponent(t)}`;
    };
  </script>
</body>
</html>
