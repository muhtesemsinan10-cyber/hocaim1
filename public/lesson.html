<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>Ders ‚Äî HocAIm</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800&display=swap" rel="stylesheet"/>

  <style>
    :root{ --bg:#fffdf7; --text:#0b1220; --muted:#475569; --border:#e5e7eb; --blue:#3b82f6; --card:#ffffff; }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{ margin:0; background:var(--bg); color:var(--text); font-family:'Montserrat',system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',sans-serif; }

    .page{ max-width:1200px; margin:auto; padding:16px; display:grid; grid-template-columns:300px 1fr; gap:16px; }
    @media(max-width:880px){ .page{ grid-template-columns:1fr; } }

    .card{ background:var(--card); border:1px solid var(--border); border-radius:16px; box-shadow:0 6px 18px rgba(0,0,0,.05); }

    /* SOL PANEL */
    .side{ padding:16px; }
    .back{ text-decoration:none; border:1px solid var(--border); border-radius:10px; padding:6px 10px; display:inline-flex; align-items:center; gap:6px; background:#fff; font-weight:600; margin-bottom:10px; }
    .brand{ font-weight:800; font-size:20px; margin-bottom:10px; display:flex; align-items:center; gap:6px; }
    .kv{ border-top:1px solid var(--border); padding-top:8px; margin-top:8px; font-size:14px; }
    .kv .row{ display:flex; justify-content:space-between; margin:4px 0; }
    .progress{ height:8px; background:#f1f5f9; border-radius:999px; overflow:hidden; margin:10px 0; }
    .bar{ width:0; height:100%; background:linear-gradient(90deg,#22c55e,#16a34a); transition:.3s; }
    .tiny{ font-size:12px; color:var(--muted); }

    .actions{ display:flex; flex-wrap:wrap; gap:6px; margin-top:8px; }
    .chipbtn{ border:1px solid var(--border); border-radius:999px; padding:8px 12px; background:#fff; font-weight:700; cursor:pointer; }
    .chipbtn:active{ transform:translateY(1px); }

    .quiz{ display:flex; align-items:center; gap:8px; border:1px dashed var(--border); padding:10px; border-radius:12px; margin-top:12px; }
    .convos{ margin-top:14px; }
    .conv-list{ display:flex; flex-direction:column; gap:6px; }
    .conv{ border:1px solid var(--border); border-radius:10px; background:#fff; padding:8px 10px; font-weight:600; display:flex; justify-content:space-between; cursor:pointer; }
    .conv small{ color:var(--muted); }

    /* SAƒû CHAT */
    .chat{ padding:14px; display:flex; flex-direction:column; height:100dvh; }
    .title{ font-size:22px; font-weight:800; margin:0 0 2px; }
    .subtitle{ margin:0 0 10px; color:var(--muted); font-size:13px; }

    .messages{ flex:1; overflow:auto; background:#fff; border:1px solid var(--border); border-radius:14px; padding:12px; scroll-behavior:smooth; }
    .msg{ display:flex; gap:10px; margin:8px 0; max-width:860px; }
    .bubble{ border:1px solid var(--border); padding:12px 14px; border-radius:14px; line-height:1.5; white-space:pre-wrap; word-break:break-word; }
    .msg.user{ justify-content:flex-end; }
    .msg.user .bubble{ background:#0b1220; color:#fff; border-color:#0b1220; }
    .msg.ai .bubble{ background:#fff; }

    .composer{ position:sticky; bottom:0; background:var(--bg); border-top:1px solid var(--border); padding-top:10px; margin-top:10px; }
    .composer-inner{ display:flex; gap:8px; align-items:center; background:#fff; border:1px solid var(--border); border-radius:12px; padding:8px 10px; }
    .composer textarea{ flex:1; resize:none; border:0; outline:0; background:transparent; max-height:160px; font:inherit; }
    .btn{ border:none; background:var(--blue); color:#fff; font-weight:800; padding:10px 16px; border-radius:12px; cursor:pointer; box-shadow:0 4px 12px rgba(59,130,246,.25); }
    .btn.secondary{ background:#f1f5f9; color:#0b1220; border:1px solid var(--border); box-shadow:none; }
    .btn:disabled{ opacity:.6; cursor:not-allowed; }

    .bubble.typing::after{ content:" ‚ñå"; animation:blink 1s steps(1) infinite; }
    @keyframes blink{ 50%{opacity:0;} }
  </style>
</head>
<body>
  <div class="page">
    <!-- SOL PANEL -->
    <aside class="card side">
      <a href="index.html" class="back">‚üµ Anasayfa</a>
      <div class="brand"><span>ü§ñ</span> HocAIm</div>

      <div class="kv">
        <div class="row"><span>Konu</span><strong id="kvTopic">‚Äî</strong></div>
        <div class="row"><span>Stil</span><strong id="kvStyle">Otomatik</strong></div>
        <div class="row"><span>S√ºre</span><strong>10 dk</strong></div>
      </div>

      <div class="progress"><div class="bar" id="bar"></div></div>
      <div class="tiny">ƒ∞lerleme: <span id="pp">0</span>%</div>

      <div class="actions">
        <button class="chipbtn" id="actSimple">Basitle≈ütir</button>
        <button class="chipbtn" id="actExample">Daha √ßok √∂rnek</button>
        <button class="chipbtn" id="actWhy">‚ÄúNeden?‚Äù de</button>
        <button class="chipbtn" id="actReExplain">Yeniden Anlat</button>
      </div>

      <div class="quiz">
        <span>üß†</span>
        <div style="flex:1">
          <div style="font-weight:800">Peki≈ütir (Mini Quiz)</div>
          <div class="tiny">Se√ßili konuya g√∂re otomatik hazƒ±rlanƒ±r.</div>
        </div>
        <a id="btnQuiz" class="chipbtn" style="font-weight:800">Ba≈ülat</a>
      </div>

      <div class="convos">
        <h4>Sohbetler</h4>
        <div class="conv-list" id="convList"></div>
        <button id="btnNew" class="chipbtn" style="margin-top:8px">+ Yeni Sohbet</button>
      </div>
    </aside>

    <!-- SAƒû CHAT -->
    <section class="card chat">
      <h2 class="title" id="title">Ders</h2>
      <p class="subtitle">‚ÄúYapay zek√¢ anlatƒ±r, senin beynine g√∂re anlatƒ±r.‚Äù</p>

      <div class="messages" id="messages"></div>

      <div class="composer">
        <div class="composer-inner">
          <textarea id="composerInput" rows="1" placeholder='√ñrn: "Termodinamik" yaz, sonra "ƒ±sƒ± ve sƒ±caklƒ±k farkƒ±?"'></textarea>
          <button id="stopBtn" class="btn secondary">Durdur</button>
          <button id="sendBtn" class="btn">G√∂nder</button>
        </div>
      </div>
    </section>
  </div>

  <script>
    /* ========= Kƒ±sa yardƒ±mcƒ±lar ========= */
    const $ = s => document.querySelector(s);
    const messages = $('#messages');
    const textarea = $('#composerInput');
    const sendBtn = $('#sendBtn');
    const stopBtn = $('#stopBtn');
    let controller = null, pct = 0;

    function scrollToBottom(){ messages.scrollTop = messages.scrollHeight; }
    function setProgress(){ $('#bar').style.width = pct + '%'; $('#pp').textContent = pct; }

    function appendRow(role){
      const row = document.createElement('div');
      row.className = `msg ${role}`;
      const bubble = document.createElement('div');
      bubble.className = 'bubble';
      row.appendChild(bubble);
      messages.appendChild(row);
      scrollToBottom();
      return bubble;
    }

    async function typeInto(el, chunk, speed=8){
      for(const ch of chunk){
        const safe = ch==='<'?'&lt;':ch==='>'?'&gt;':ch;
        el.innerHTML += safe;
        scrollToBottom();
        if(speed) await new Promise(r=>setTimeout(r,speed));
      }
    }

    /* ========= Topic √ßƒ±karƒ±mƒ± ‚Äî √∂l√ßeklenebilir ========= */

    // Kanonik k√ºt√ºphane (kƒ±sa; b√ºy√ºt√ºlebilir)
    const TOPIC_LIB = {
      // maj√∂r alanlar (geni≈ü)
      "Fizik":      ["fizik","mekanik","kuvvet","hareket","enerji","optik","dalga","dalgalar","elektrik","manyetizma","ƒ±sƒ±","sƒ±caklƒ±k"],
      "Matematik":  ["matematik","mat","geometri","cebir","analiz","fonksiyon","limit","t√ºrev","integral"],
      "Kimya":      ["kimya","molek√ºl","reaksiyon","asit","baz","tuz","periyodik","element"],
      "Biyoloji":   ["biyoloji","h√ºcre","canlƒ±","dna","protein","ekoloji","metabolizma"],
      "T√ºrk√ße":     ["t√ºrk√ße","dil bilgisi","paragraf","s√∂zc√ºk","c√ºmle","anlam"],

      // sƒ±k alt konular (gerektik√ße ekle)
      "Termodinamik": ["termodinamik","ƒ±sƒ± bilimi"],
      "Frekans":      ["frekans","hertz","hz"],
      "Optik":        ["optik","yansƒ±ma","kƒ±rƒ±lma","mercek","ayna"],
      "Limit":        ["limit"],
      "T√ºrev":        ["t√ºrev"],
      "ƒ∞ntegral":     ["integral","alan hesabƒ±"]
    };

    // Kullanƒ±cƒ±dan √∂ƒürenilen konular (yerel)
    const LIB_KEY = "hocaim.topic_lib";
    let USER_TOPICS = {};
    try { USER_TOPICS = JSON.parse(localStorage.getItem(LIB_KEY) || "{}"); } catch {}
    function saveUserTopic(term){
      if (!term) return;
      if (!USER_TOPICS[term]) {
        USER_TOPICS[term] = [term.toLowerCase()];
        localStorage.setItem(LIB_KEY, JSON.stringify(USER_TOPICS));
      }
    }

    const norm = s => (s||"")
      .toLowerCase()
      .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
      .replace(/[^\p{L}\p{N}\s\.]/gu," ")
      .replace(/\s+/g," ")
      .trim();

    function titleCase(s){
      return s.replace(/\w\S*/g, t => t.charAt(0).toUpperCase()+t.slice(1).toLowerCase());
    }

    function firstQuoted(text){
      const m = text.match(/[‚Äú‚Äù"']([^‚Äú‚Äù"']{2,80})[‚Äú‚Äù"']/);
      return m ? m[1].trim() : null;
    }

    function matchFromLibrary(text){
      const s = norm(text);

      // √∂nce kullanƒ±cƒ± s√∂zl√ºƒü√º
      for (const k of Object.keys(USER_TOPICS)) {
        for (const token of USER_TOPICS[k]||[]) {
          if (s.includes(token)) return k;
        }
      }
      // maj√∂r alanlar
      const majors = ["Fizik","Matematik","Kimya","Biyoloji","T√ºrk√ße"];
      for (const k of majors) {
        for (const token of TOPIC_LIB[k]||[]) {
          if (s.includes(norm(token))) return k;
        }
      }
      // diƒüer t√ºm ba≈ülƒ±klar
      for (const k of Object.keys(TOPIC_LIB)) {
        for (const token of TOPIC_LIB[k]) {
          if (s.includes(norm(token))) return k;
        }
      }
      return null;
    }

    function inferTopic(userText){
      const raw = userText || "";
      const s = norm(raw);

      // 1) "konu: x" / tƒ±rnak i√ßi / "x nedir"
      const k = s.match(/\bkonu[:=]\s*([^\n]{2,60})/i);
      if (k?.[1]) return titleCase(k[1].trim());
      const quoted = firstQuoted(raw);
      if (quoted) return titleCase(quoted);
      const nedir = s.match(/(.{2,60})\s+nedir\??$/i);
      if (nedir?.[1]) return titleCase(nedir[1].trim());

      // 2) sƒ±nƒ±f + bran≈ü (4. sƒ±nƒ±f fizik)
      const sb = s.match(/\b(\d+)\.*\s*s[ƒ±i]n[ƒ±i]f\s+(fizik|mat(ematik)?|kimya|biyoloji|t[√ºu]rk[√ßc]e)/);
      if (sb?.[2]) {
        const map = { "fizik":"Fizik","mat":"Matematik","matematik":"Matematik","kimya":"Kimya","biyoloji":"Biyoloji","t√ºrk√ße":"T√ºrk√ße","turkce":"T√ºrk√ße" };
        return map[norm(sb[2])] || titleCase(sb[2]);
      }

      // 3) k√ºt√ºphane e≈üle≈ümesi
      const libHit = matchFromLibrary(s);
      if (libHit) return libHit;

      // 4) son kelime(ler)
      const tail = s.split(/\s+/).slice(-3).join(" ");
      if (tail && tail.length>=3) return titleCase(tail);

      return null;
    }

    // ‚ÄúYapƒ±≈ükan‚Äù mantƒ±k: geni≈ü -> dar
    function isNarrower(candidate, current){
      if (!current) return true;
      const majors = ["Fizik","Matematik","Kimya","Biyoloji","T√ºrk√ße"];
      return majors.includes(current) && candidate && candidate !== current;
    }

    /* ========= Konu durumu ========= */
    const state = { topic:null, style:'Otomatik' };
    $('#kvStyle').textContent = 'Otomatik';

    function setTopic(t){
      state.topic = t;
      $('#kvTopic').textContent = t || '‚Äî';
      $('#title').textContent = t ? `‚Äú${t}‚Äù konusunu √∂ƒürenelim` : 'Ders';
      const c = getActive(); if (c){ c.title = t || 'Sohbet'; save(); renderConvos(); }
    }

    function maybeUpdateTopic(candidate){
      if (!candidate) return;
      if (!state.topic || isNarrower(candidate, state.topic)) {
        setTopic(candidate);
        saveUserTopic(candidate);
      }
    }

    /* ========= LocalStorage sohbet y√∂netimi ========= */
    const STORE="hocaim.convos";
    let convos = JSON.parse(localStorage.getItem(STORE) || "[]");
    let activeId = convos[0]?.id || null;

    function save(){ localStorage.setItem(STORE, JSON.stringify(convos)); }
    function ensureActive(){
      if(!activeId){
        const id=Date.now().toString();
        convos.unshift({id,title:'Yeni sohbet',turns:[]});
        activeId=id; save();
      }
    }
    function getActive(){ return convos.find(c=>c.id===activeId) || null; }
    function pushTurn(role, content){
      const c = getActive(); if(!c) return;
      c.turns.push({role, content}); save();
    }
    function renderConvos(){
      const list = $('#convList'); list.innerHTML='';
      convos.forEach(c=>{
        const div=document.createElement('div');
        div.className='conv';
        div.innerHTML=`<span>${c.title||'Sohbet'}</span><small>‚ûú</small>`;
        div.onclick=()=>{ activeId=c.id; loadChat(); };
        list.appendChild(div);
      });
    }
    function loadChat(){
      const c = getActive();
      messages.innerHTML=''; state.topic=null;
      if(!c) return;
      setTopic(c.title!=='Yeni sohbet'?c.title:null);
      for(const t of c.turns){
        const b = appendRow(t.role);
        b.innerHTML = t.content;
      }
      scrollToBottom();
    }

    $('#btnNew').onclick=()=>{
      const id=Date.now().toString();
      convos.unshift({id,title:'Yeni sohbet',turns:[]});
      activeId=id; save(); renderConvos(); loadChat();
      const b = appendRow('ai');
      b.innerHTML = 'Selam, ben <strong>HocAIm</strong>! Hangi konuda √ßalƒ±≈ümak istersin?';
      pushTurn('assistant', b.innerHTML);
    };

    /* ========= Streaming explain (yalnƒ±zca KULLANICI METNƒ∞NE g√∂re topic) ========= */
    async function askExplain(message, topic){
      { const b=appendRow('user'); b.innerHTML = message; pushTurn('user', message); }

      const ai = appendRow('ai'); ai.classList.add('typing');
      controller = new AbortController();

      try{
        const history = (getActive()?.turns || []).slice(-8);
        const res = await fetch('/api/explain', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ message, topic, history }),
          signal: controller.signal
        });

        if(!res.ok){
          ai.classList.remove('typing');
          ai.textContent = 'Baƒülantƒ± kesildi.';
          return;
        }

        const ct = (res.headers.get('content-type') || '').toLowerCase();

        if (ct.includes('application/json')){
          const data = await res.json();
          const html = data.html || data.text || JSON.stringify(data);
          ai.classList.remove('typing');
          ai.innerHTML = html;
          pushTurn('assistant', html);
          pct = Math.min(100, pct+10); setProgress();
          return;
        }

        if (!res.body){
          ai.classList.remove('typing');
          ai.textContent = await res.text();
          pushTurn('assistant', ai.textContent);
          return;
        }

        const reader = res.body.getReader();
        const dec = new TextDecoder();
        let buf = '';
        while(true){
          const {value,done} = await reader.read();
          if(done) break;
          const chunk = dec.decode(value,{stream:true});
          buf += chunk;
          await typeInto(ai, chunk, 8);
        }
        ai.classList.remove('typing');
        pushTurn('assistant', buf);
        pct = Math.min(100, pct+10); setProgress();
      }catch(err){
        ai.classList.remove('typing');
        ai.textContent = 'Baƒülantƒ± kesildi.';
      }finally{ controller=null; }
    }

    /* ========= Aksiyonlar ========= */
    function runAction(prompt){
      if(!state.topic){
        const ai=appendRow('ai'); ai.innerHTML='√ñnce bir konu yazmalƒ±sƒ±n üôÇ';
        pushTurn('assistant', ai.innerHTML); return;
      }
      const merged = `${prompt}\n\nKonu: ${state.topic}`;
      askExplain(merged, state.topic);
    }
    $('#actSimple').onclick   = ()=> runAction('Bu konuyu daha basit, 3 maddede √∂zetle. K√º√ß√ºk ipucu ekle.');
    $('#actExample').onclick  = ()=> runAction('Bu konu i√ßin 2 kolay + 1 orta seviye √ß√∂z√ºml√º soru √ºret.');
    $('#actWhy').onclick      = ()=> runAction('Bu kavram neden √∂nemli? 4-6 c√ºmlede a√ßƒ±kla, 1 ger√ßek hayat √∂rneƒüi ver.');
    $('#actReExplain').onclick= ()=> runAction('Aynƒ± konuyu farklƒ± bir √ºslupla yeniden a√ßƒ±kla.');

    /* ========= Quiz ========= */
    $('#btnQuiz').onclick = ()=>{
      const t = state.topic || 'Genel';
      location.href = `quiz.html?topic=${encodeURIComponent(t)}`;
    };

    /* ========= Enter & G√∂nder & Durdur ========= */
    sendBtn.onclick = ()=>{
      const val = textarea.value.trim();
      if(!val) return;
      textarea.value = '';

      // Konu sadece KULLANICI METNƒ∞NDEN √ßƒ±karƒ±lƒ±r + yapƒ±≈ükan (geni≈ü->dar)
      const candidate = inferTopic(val);
      maybeUpdateTopic(candidate);

      askExplain(val, state.topic);
      textarea.focus();
    };
    textarea.addEventListener('keydown',e=>{
      if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); sendBtn.click(); }
    });
    stopBtn.onclick = ()=>{ try{ controller?.abort(); }catch{} };

    /* ========= ƒ∞lk y√ºkleme ========= */
    ensureActive(); renderConvos(); loadChat();
    if((getActive()?.turns||[]).length===0){
      const b=appendRow('ai'); b.innerHTML='Selam, ben <strong>HocAIm</strong>! Hangi konuda √ßalƒ±≈ümak istersin?';
      pushTurn('assistant', b.innerHTML);
    }
  </script>
</body>
</html>
