<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>Ders â€” HocAIm</title>
  <link rel="stylesheet" href="style.css"/>

  <style>
    :root{ --bg:#fffdf7; --text:#0b1220; --muted:#475569; --border:#e5e7eb; --blue:#3b82f6; }
    body{ margin:0; background:var(--bg); color:var(--text); }
    html, body { height:100%; }
    .page{ max-width:1320px; margin:auto; padding:18px 24px; }

    .topbar{ display:flex; align-items:center; gap:12px; margin-bottom:10px; }
    .topbar h1{ margin:0; font-weight:800; }

    .layout{ display:grid; grid-template-columns:2.2fr .8fr; gap:18px; min-height:calc(100vh - 120px); }
    @media (max-width:1100px){ .layout{ grid-template-columns:1fr; min-height:unset; } }

    .card{ background:#fff; border:1px solid var(--border); border-radius:18px; box-shadow:0 10px 24px rgba(0,0,0,.06); padding:16px; }
    .chat{ display:flex; flex-direction:column; height:calc(100vh - 160px); }
    @media (max-width:1100px){ .chat{ height:auto; } }

    .chat-head{ display:flex; align-items:center; justify-content:space-between; padding-bottom:12px; border-bottom:1px solid var(--border); }
    .title{ font-weight:900; }

    .thread{ flex:1; overflow:auto; padding:10px 0; scroll-behavior:smooth; }
    .msg{ display:flex; gap:10px; margin:12px 0; align-items:flex-start; }
    .ava{ width:40px; height:40px; border-radius:999px; display:grid; place-items:center; background:#0ea5e9; color:#fff; font-weight:800; flex:0 0 40px; }
    .me .ava{ background:#0b1220; }
    .bubble{ border:1px solid var(--border); border-radius:14px; padding:12px 14px; background:#fff; white-space:pre-wrap; word-break:break-word; max-width:100%; line-height:1.5; }
    .me .bubble{ background:#0b1220; color:#fff; border-color:#0b1220; }

    .chip{ border:1px solid var(--border); border-radius:999px; padding:6px 10px; font-weight:700; }
    .btn{ display:inline-flex; align-items:center; gap:8px; border:1.5px solid var(--text); border-radius:12px; padding:10px 14px; font-weight:800; cursor:pointer; text-decoration:none; }
    .btn.blue{ background:var(--blue); color:#fff; border-color:var(--blue); box-shadow:0 6px 16px rgba(59,130,246,.22); }

    .foot{ display:flex; gap:10px; padding-top:12px; border-top:1px solid var(--border); background:#fff; }
    .in{ flex:1; padding:12px; border:1px solid var(--border); border-radius:12px; font:inherit; }

    .side .grid{ display:grid; grid-template-columns:1fr auto; gap:8px 12px; }
    .muted{ color:var(--muted); }
    .progress{ height:10px; background:#f1f5f9; border-radius:999px; overflow:hidden; margin:12px 0 6px; }
    .bar{ display:block; height:100%; width:0; background:linear-gradient(90deg,#22c55e,#16a34a); }

    .actions{ display:flex; gap:8px; flex-wrap:wrap; }
    .actions .btn{ padding:8px 12px; border-radius:999px; }

    /* --- MOBILE OPTIMIZATION PACK --- */
    @media (max-width: 480px) {
      .page { padding: 14px 12px; }
      .layout { gap: 10px; }
      .card { border-radius: 16px; }

      .chat-head { padding-bottom: 10px; }
      .title { font-size: 16px; line-height: 1.25; word-wrap: break-word; hyphens: auto; }
      .chip { font-size: 12px; padding: 5px 8px; }

      /* Header saÄŸ taraf (Otomatik + Quiz) dikey dizilsin */
      .chat-head > div:last-child { display:flex; flex-direction: column; align-items: stretch; gap: 8px; }

      .thread { padding: 8px 0; }
      .msg { margin: 10px 0; }
      .bubble { line-height: 1.45; }

      .btn { min-height: 44px; font-size: 14px; }
      .actions .btn { min-height: 38px; font-size: 13px; }

      .in { min-height: 44px; font-size: 15px; padding: 12px; }

      /* Alt bar sabit kalsÄ±n; iPhone Ã§entik uyumlu */
      .foot {
        position: sticky; bottom: 0; z-index: 5;
        backdrop-filter: blur(8px);
        padding-bottom: calc(10px + env(safe-area-inset-bottom));
      }
    }
  </style>
</head>
<body>
  <div class="page">
    <header class="topbar">
      <a href="dashboard.html" class="btn">âŸµ Panel</a>
      <h1 class="lesson-title">Ders</h1>
    </header>

    <div class="layout">
      <!-- SOL: Sohbet -->
      <section class="card chat">
        <div class="chat-head">
          <div>
            <div id="title" class="title">Ders</div>
            <small class="muted">AI anlatÄ±mÄ±: stiline gÃ¶re</small>
          </div>
          <div style="display:flex; gap:8px; align-items:center;">
            <span id="modeChip" class="chip">Otomatik</span>
            <a id="btnQuiz" class="btn">ğŸ§  PekiÅŸtir (Mini Quiz)</a>
          </div>
        </div>

        <div id="thread" class="thread"></div>

        <div class="foot">
          <input id="ask" class="in" placeholder='Ã–rn: "Trigonometri" yaz ve baÅŸla; sonra sor: "sin-cos iliÅŸkisi?"'/>
          <button id="send" class="btn blue">GÃ¶nder</button>
        </div>
      </section>

      <!-- SAÄ: Ã–zet & HÄ±zlÄ± Aksiyon -->
      <aside class="card side">
        <h3>Ã–zet</h3>
        <div class="grid">
          <span class="muted">Konu</span> <strong id="kvTopic">â€”</strong>
          <span class="muted">Stil</span> <strong id="kvStyle">Otomatik</strong>
          <span class="muted">SÃ¼re</span> <strong id="kvTime">10 dk</strong>
        </div>

        <div class="progress"><span id="bar" class="bar"></span></div>
        <small class="muted">Ä°lerleme: <span id="pp">0</span>%</small>

        <h3 style="margin-top:14px;">HÄ±zlÄ± Aksiyon</h3>
        <div class="actions">
          <button id="actSimple"  class="btn">BasitleÅŸtir</button>
          <button id="actExample" class="btn">Daha Ã§ok Ã¶rnek</button>
          <button id="actWhy"     class="btn">â€œNeden?â€ de</button>
        </div>
      </aside>
    </div>
  </div>

  <!-- ====== APP SCRIPT ====== -->
  <script>
    const $ = s => document.querySelector(s);

    // â€”â€”â€” Profil / baÅŸlangÄ±Ã§ stil â€”â€”â€”
    let profile = null; try{ profile = JSON.parse(localStorage.getItem('ch.profile')||'null'); }catch{}
    const initialStyle = profile?.primary?.code || 'auto';
    $('#kvStyle').textContent = ({V:'GÃ¶rsel',A:'Ä°ÅŸitsel',R:'Okuma-Yazma',K:'Kinestetik',auto:'Otomatik'})[initialStyle] || 'Otomatik';

    const state = { topic:null, domain:'general', style:initialStyle, level: profile?.level || 'Lise' };

    // â€”â€”â€” UI helpers â€”â€”â€”
    const thread = $('#thread');
    function addBot(html){
      const d=document.createElement('div'); d.className='msg';
      d.innerHTML = `<div class="ava">H</div><div class="bubble">${html}</div>`;
      thread.appendChild(d); thread.scrollTop=thread.scrollHeight;
      turns.push({ role:'assistant', content:String(html).replace(/\s+/g,' ').slice(0,500) });
      maybeInferStyle();
    }
    function addMe(text){
      const d=document.createElement('div'); d.className='msg me';
      d.innerHTML = `<div class="bubble">${text}</div><div class="ava">ğŸ‘¤</div>`;
      thread.appendChild(d); thread.scrollTop=thread.scrollHeight;
      turns.push({ role:'user', content:text.slice(0,300) });
    }
    function setTitleTopic(){
      $('#title').textContent = state.topic ? `â€œ${state.topic}â€ konusunu birlikte Ã¶ÄŸrenelim` : 'Ders';
      $('#kvTopic').textContent = state.topic || 'â€”';
    }
    let pct=0; function tick(){ pct=Math.min(100,pct+10); $('#bar').style.width=pct+'%'; $('#pp').textContent=pct; }

    // Otomatik aÅŸaÄŸÄ± kaydÄ±rma (her yeni mesajda)
    const observer = new MutationObserver(()=>{ thread.scrollTop = thread.scrollHeight; });
    observer.observe(thread, { childList: true });

    // Son bot mesajÄ± (hÄ±zlÄ± aksiyonlar iÃ§in)
    function getLastBotText(){
      const nodes = Array.from(document.querySelectorAll('#thread .msg'));
      for (let i = nodes.length - 1; i >= 0; i--){
        if (!nodes[i].classList.contains('me')){
          const b = nodes[i].querySelector('.bubble');
          if (b) return b.innerText || b.textContent || '';
        }
      }
      return '';
    }
    const styleLabel = c => ({V:'GÃ¶rsel',A:'Ä°ÅŸitsel',R:'Okuma-Yazma',K:'Kinestetik',auto:'Otomatik'})[c] || 'Otomatik';

    // â€”â€”â€” AkÄ±llÄ± KONu Ã§Ä±karma (kanonik + domain) â€”â€”â€”
    const TOPIC_RULES = [
      { re:/baÄŸlaÃ§\w*/i,         canon:'BaÄŸlaÃ§lar',         domain:'lang' },
      { re:/zamir\w*/i,          canon:'Zamirler',          domain:'lang' },
      { re:/sÄ±fat\w*/i,          canon:'SÄ±fatlar',          domain:'lang' },
      { re:/fiil\w*/i,           canon:'Fiiller',           domain:'lang' },
      { re:/cÃ¼mle (Ã¶ÄŸeleri|tÃ¼rleri|bilgisi)/i, canon:'CÃ¼mle Bilgisi', domain:'lang' },

      { re:/trigonometri/i,      canon:'Trigonometri',      domain:'math' },
      { re:/limit/i,             canon:'Limit',             domain:'math' },
      { re:/integral/i,          canon:'Ä°ntegral',          domain:'math' },
      { re:/tÃ¼rev/i,             canon:'TÃ¼rev',             domain:'math' },
    ];
    const STOP = new Set(['selam','merhaba','hocam','hoca','acaba','bana','yardÄ±m','eder','misin','nedir','nelerdir','nasÄ±l','konusunu','konusunda','hakkÄ±nda','ile','ilgili','anlamÄ±yorum','zorlanÄ±yorum','sÄ±kÄ±ntÄ±','yaÅŸÄ±yorum','var','mÄ±','mi']);

    function extractTopic(raw){
      const lower = raw.toLowerCase().replace(/[^\p{L}\p{N}\s]/gu,' ').replace(/\s+/g,' ').trim();
      // 1) KurallÄ± eÅŸleÅŸme
      for (const r of TOPIC_RULES){
        if (r.re.test(lower)) return { topic:r.canon, domain:r.domain };
      }
      // 2) Stopwords at â†’ ilk 1-2 kelimeyi baÅŸlÄ±k yap
      const words = lower.split(' ').filter(w=>!STOP.has(w)).slice(0,2);
      const t = words.map(w=>w.replace(/\b\p{L}/u,m=>m.toUpperCase())).join(' ');
      return { topic: t || 'Genel', domain:'general' };
    }

    // â€”â€”â€” Sunucu kÃ¶prÃ¼leri â€”â€”â€”
    async function explain({ prompt, topic, extra }){
      const r = await fetch('/api/explain',{
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ prompt, topic, style: state.style, level: state.level, context: extra||'' })
      });
      return r.json();
    }

    // â€”â€”â€” Stil Ã§Ä±karÄ±mÄ± (mesaj atma YOK, sadece Ã¶zeti gÃ¼ncelle) â€”â€”â€”
    let turns=[]; let inferCounter=0;
    async function maybeInferStyle(){
      inferCounter++;
      if (inferCounter % 3 !== 0) return;
      try{
        const r = await fetch('/api/style-infer',{
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ turns: turns.slice(-8) })
        });
        const data = await r.json();
        if (data?.ok && data.style && data.confidence >= 60){
          state.style = data.style;
          const label = styleLabel(data.style);
          $('#kvStyle').textContent = label;
          $('#modeChip').textContent = label;
          // sohbet iÃ§ine mesaj atma!
        }
      }catch(e){ console.error(e); }
    }

    // â€”â€”â€” KarÅŸÄ±lama â€”â€”â€”
    addBot('Hangi konuda yardÄ±mcÄ± olmamÄ± istersin? Ã–rn: <em>limit, integral, trigonometri, baÄŸlaÃ§lar, zamirlerâ€¦</em>');
    setTitleTopic();

    // â€”â€”â€” GÃ¶nder â€”â€”â€”
    const $ask = $('#ask'); const $send = $('#send');
    $send.addEventListener('click', async ()=>{
      const text = ($ask.value||'').trim();
      if (!text) return;
      addMe(text); $ask.value='';

      // Konu yoksa: Ã§Ä±kar, baÅŸlÄ±ÄŸÄ±/Ã¶zeti gÃ¼ncelle ve giriÅŸ Ã¼ret
      if (!state.topic){
        const res = extractTopic(text);
        state.topic  = res.topic;
        state.domain = res.domain;
        setTitleTopic();

        addBot(`Harika! <strong>${state.topic}</strong> ile baÅŸlayalÄ±m. KÄ±sa bir giriÅŸ hazÄ±rlÄ±yorumâ€¦`);
        try{
          const data = await explain({ topic: state.topic });
          addBot(data?.ok ? data.html : 'AI yanÄ±tÄ± alÄ±namadÄ±, tekrar dener misin?');
          if (data?.ok) tick();
        }catch(e){ console.error(e); addBot('Bir hata oluÅŸtu.'); }
        return;
      }

      // Konu belirlendiyse normal soru
      try{
        const data = await explain({ prompt: text, topic: state.topic });
        addBot(data?.ok ? data.html : 'AI yanÄ±tÄ± alÄ±namadÄ±.');
        if (data?.ok) tick();
      }catch(e){ console.error(e); addBot('Bir hata oluÅŸtu.'); }
    });
    $ask.addEventListener('keydown', e=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); $send.click(); } });

    // â€”â€”â€” HÄ±zlÄ± aksiyonlar: konu + son bot cevabÄ± baÄŸlamÄ±yla â€”â€”â€”
    function topicGuard(){ if (!state.topic){ addBot('Ã–nce bir konu yaz ğŸ™‚'); return false; } return true; }

    $('#actSimple').addEventListener('click', async ()=>{
      if (!topicGuard()) return;
      const base = getLastBotText() || `Konu: ${state.topic}`;
      const prompt = `KONU: ${state.topic}
STÄ°L: ${styleLabel(state.style)}
AÅŸaÄŸÄ±daki aÃ§Ä±klamayÄ± bu konu iÃ§in daha basit, kÄ±sa ve 3 madde halinde Ã¶zetle. Gerekirse minik bir ipucu/benzetme ekle.

--- METÄ°N ---
${base}
--- SON ---
`;
      const data = await explain({ prompt, topic: state.topic });
      addBot(data?.ok ? data.html : 'â€”'); if (data?.ok) tick();
    });

    $('#actExample').addEventListener('click', async ()=>{
      if (!topicGuard()) return;
      const base = getLastBotText() || `Konu: ${state.topic}`;
      // konu alanÄ±na gÃ¶re Ã¶rnek isteÄŸini sabitle
      const isLang = state.domain === 'lang';
      const isMath = state.domain === 'math';
      const task = isLang
        ? `Bu konu TÃœRKÃ‡E DÄ°LBÄ°LGÄ°SÄ° kapsamÄ±ndadÄ±r. 3 Ã¶rnek cÃ¼mle yaz:
- her cÃ¼mlenin yanÄ±na kÄ±sa aÃ§Ä±klama koy
- yanlÄ±ÅŸ Ã¶rnek + dÃ¼zeltmesini de ekle (en az 1 adet)`
        : isMath
        ? `Bu konu MATEMATÄ°K kapsamÄ±ndadÄ±r. 2 kolay + 1 orta seviye Ã‡Ã–ZÃœMLÃœ soru Ã¼ret:
- her soruyu adÄ±m adÄ±m Ã§Ã¶z
- yaygÄ±n yapÄ±lan bir hatayÄ± gÃ¶ster ve dÃ¼zelt`
        : `Bu konu iÃ§in 3 somut ve gÃ¼nlÃ¼k hayattan Ã¶rnek Ã¼ret; her Ã¶rneÄŸi kÄ±sa aÃ§Ä±klamayla aÃ§Ä±kla.`;

      const prompt = `KONU: ${state.topic}
STÄ°L: ${styleLabel(state.style)}
${task}

--- ELÄ°MDEKÄ° AÃ‡IKLAMA ---
${base}
--- SON ---
`;
      const data = await explain({ prompt, topic: state.topic });
      addBot(data?.ok ? data.html : 'â€”'); if (data?.ok) tick();
    });

    $('#actWhy').addEventListener('click', async ()=>{
      if (!topicGuard()) return;
      const base = getLastBotText() || `Konu: ${state.topic}`;
      const prompt = `KONU: ${state.topic}
Bu kavram neden Ã¶nemlidir, nerelerde iÅŸime yarar? 4-6 cÃ¼mlede aÃ§Ä±kla.
1 gerÃ§ek hayat kullanÄ±m senaryosu ver. Dili ${styleLabel(state.style)} stile uygun, anlaÅŸÄ±lÄ±r olsun.

--- METÄ°N ---
${base}
--- SON ---
`;
      const data = await explain({ prompt, topic: state.topic });
      addBot(data?.ok ? data.html : 'â€”'); if (data?.ok) tick();
    });

    // Quiz
    $('#btnQuiz').addEventListener('click', ()=>{
      const t = state.topic || 'Genel';
      location.href = `quiz.html?topic=${encodeURIComponent(t)}`;
    });
  </script>
</body>
</html>